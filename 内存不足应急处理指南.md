# 内存不足应急处理指南

## 🚨 紧急情况识别

### 内存不足的典型症状：
- 服务器响应极慢或无响应
- 爬虫任务频繁失败
- 小程序加载超时
- 系统自动重启
- 出现 "Out of Memory" 错误

### 快速检查命令：
```bash
# 查看内存使用情况
free -h

# 查看进程内存占用
ps aux --sort=-%mem | head -10

# 查看系统负载
top

# 查看Node.js进程
ps aux | grep node
```

## 🆘 立即应急措施

### 1. 释放内存（立即可执行）
```bash
# 清理缓存
sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches

# 清理swap
sudo swapoff -a && sudo swapon -a

# 重启Node.js服务
pkill -f "smart-tea-crawler"
sleep 5
node smart-tea-crawler-optimized.js &
```

### 2. 临时降低服务负载
```bash
# 停止非必要服务
sudo systemctl stop nginx  # 如果不需要web服务
sudo systemctl stop mysql  # 如果不需要数据库

# 降低Node.js内存限制
export NODE_OPTIONS="--max-old-space-size=512"
```

### 3. 清理日志文件
```bash
# 清理大日志文件
find . -name "*.log" -size +10M -delete
find . -name "crawler.log" -exec truncate -s 1M {} \;

# 清理临时文件
rm -rf /tmp/*
```

## 🔧 中期优化方案

### 1. 使用优化版爬虫
```bash
# 停止原版爬虫
pkill -f "smart-tea-crawler.js"

# 启动优化版
node smart-tea-crawler-optimized.js &
```

### 2. 启用内存监控
```bash
# 启动内存监控
node memory-monitor.js &

# 设置监控间隔（每30秒检查一次）
node -e "
const monitor = require('./memory-monitor');
monitor.startMonitoring(30000);
"
```

### 3. 配置系统优化
```bash
# 编辑系统配置
sudo nano /etc/sysctl.conf

# 添加以下配置
vm.swappiness=10
vm.vfs_cache_pressure=50
vm.dirty_ratio=15
vm.dirty_background_ratio=5

# 应用配置
sudo sysctl -p
```

## 📈 长期解决方案

### 1. 升级服务器配置
**推荐配置升级路径：**
- 当前：2核2G
- 短期：2核4G（增加内存）
- 中期：4核4G（增加CPU和内存）
- 长期：4核8G（完整升级）

### 2. 架构优化
```javascript
// 使用流式处理替代内存加载
const fs = require('fs');
const readline = require('readline');

// 分批处理数据
const batchSize = 100;
let batch = [];

// 使用缓存减少重复计算
const cache = new Map();
```

### 3. 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_articles_date ON articles(pub_date);
CREATE INDEX idx_articles_category ON articles(category);

-- 定期清理旧数据
DELETE FROM articles WHERE pub_date < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

## 🛠️ 预防措施

### 1. 设置监控告警
```bash
# 创建监控脚本
cat > /usr/local/bin/memory-alert.sh << 'EOF'
#!/bin/bash
MEM_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
if [ $MEM_USAGE -gt 80 ]; then
    echo "内存使用率过高: ${MEM_USAGE}%" | mail -s "服务器告警" admin@example.com
fi
EOF

chmod +x /usr/local/bin/memory-alert.sh

# 添加到crontab
echo "*/5 * * * * /usr/local/bin/memory-alert.sh" | crontab -
```

### 2. 定期维护
```bash
# 创建维护脚本
cat > /usr/local/bin/weekly-maintenance.sh << 'EOF'
#!/bin/bash
# 清理日志
find /var/log -name "*.log" -size +10M -delete
# 清理临时文件
rm -rf /tmp/*
# 重启服务
systemctl restart nginx
systemctl restart nodejs
EOF

chmod +x /usr/local/bin/weekly-maintenance.sh

# 每周日凌晨2点执行
echo "0 2 * * 0 /usr/local/bin/weekly-maintenance.sh" | crontab -
```

### 3. 备份策略
```bash
# 创建自动备份脚本
cat > /usr/local/bin/backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
tar -czf /backup/tea-platform_$DATE.tar.gz /opt/tea-platform
# 保留最近7天的备份
find /backup -name "tea-platform_*.tar.gz" -mtime +7 -delete
EOF

chmod +x /usr/local/bin/backup.sh

# 每天凌晨3点备份
echo "0 3 * * * /usr/local/bin/backup.sh" | crontab -
```

## 📞 联系支持

### 紧急联系方式：
- **技术支持**：admin@tea-platform.com
- **服务器提供商**：腾讯云客服
- **文档地址**：https://github.com/tea-platform/docs

### 需要提供的信息：
1. 服务器IP地址
2. 错误日志内容
3. 内存使用截图
4. 系统负载情况
5. 最近的操作记录

## ✅ 检查清单

### 应急处理完成检查：
- [ ] 内存使用率降至80%以下
- [ ] 服务正常响应
- [ ] 爬虫任务正常运行
- [ ] 日志文件已清理
- [ ] 监控系统已启动
- [ ] 备份已完成

### 长期优化检查：
- [ ] 优化版爬虫已部署
- [ ] 系统配置已优化
- [ ] 监控告警已设置
- [ ] 维护计划已制定
- [ ] 升级方案已评估

---

**记住：预防胜于治疗，定期监控和优化是避免内存不足的最佳方法！** 