# 用户系统增强使用指南

## 概述

用户系统增强功能为茶叶一点通小程序提供了完整的用户管理功能，包括用户资料管理、收藏功能、浏览历史、消息通知、用户关注、私信系统等核心功能。

## 功能特性

### 1. 用户资料管理
- **个人资料维护**：昵称、头像、联系方式、个人简介等
- **偏好设置**：用户个性化偏好配置
- **资料同步**：多设备资料同步

### 2. 收藏功能
- **多类型收藏**：支持市场、新品、供求、清仓、内容等多种类型
- **收藏管理**：添加、删除、查看收藏列表
- **收藏状态**：实时检查收藏状态

### 3. 浏览历史
- **自动记录**：自动记录用户浏览行为
- **历史管理**：查看、清空浏览历史
- **分类筛选**：按内容类型筛选历史记录

### 4. 消息通知
- **系统通知**：系统消息、活动通知
- **未读提醒**：未读消息数量统计
- **通知管理**：标记已读、全部已读

### 5. 用户关注
- **关注用户**：关注其他用户
- **关注管理**：查看关注列表、取消关注
- **关注状态**：检查关注状态

### 6. 私信系统
- **发送私信**：用户间私信交流
- **消息管理**：查看私信列表、对话记录
- **消息类型**：支持文本、图片、文件等类型

### 7. 活动记录
- **行为追踪**：记录用户各种操作行为
- **数据分析**：为个性化推荐提供数据支持
- **活动统计**：用户活跃度分析

## 后端API接口

### 用户资料管理

#### 获取用户资料
```http
GET /api/user/profile
```

**响应示例：**
```json
{
  "status": "success",
  "data": {
    "id": 1,
    "user_id": 1,
    "nickname": "茶叶爱好者",
    "avatar": "avatar.jpg",
    "phone": "13800138000",
    "email": "user@example.com",
    "gender": "male",
    "birthday": "1990-01-01",
    "location": "北京市",
    "company": "茶叶公司",
    "position": "采购经理",
    "bio": "热爱茶叶文化",
    "preferences": {
      "favorite_categories": ["绿茶", "红茶"],
      "notification_settings": {
        "email": true,
        "push": true
      }
    },
    "created_at": "2024-01-01T00:00:00",
    "updated_at": "2024-01-01T00:00:00"
  }
}
```

#### 更新用户资料
```http
PUT /api/user/profile
Content-Type: application/json

{
  "nickname": "新昵称",
  "email": "new@example.com",
  "phone": "13900139000",
  "gender": "female",
  "location": "上海市",
  "company": "新公司",
  "position": "新职位",
  "bio": "新的个人简介"
}
```

### 收藏管理

#### 获取收藏列表
```http
GET /api/user/favorites?type=market&page=1&per_page=10
```

**参数说明：**
- `type`: 收藏类型（market, newarrival, supply, clearance, content）
- `page`: 页码
- `per_page`: 每页数量

#### 添加收藏
```http
POST /api/user/favorites
Content-Type: application/json

{
  "item_type": "market",
  "item_id": 1,
  "title": "茶叶市场名称",
  "description": "市场描述"
}
```

#### 取消收藏
```http
DELETE /api/user/favorites/{favorite_id}
```

### 浏览历史

#### 获取浏览历史
```http
GET /api/user/history?type=newarrival&page=1&per_page=10
```

#### 添加浏览历史
```http
POST /api/user/history
Content-Type: application/json

{
  "item_type": "newarrival",
  "item_id": 1,
  "title": "新品标题",
  "description": "新品描述"
}
```

#### 清空浏览历史
```http
DELETE /api/user/history?type=newarrival
```

### 消息通知

#### 获取通知列表
```http
GET /api/user/notifications?is_read=false&type=system&page=1&per_page=10
```

#### 标记通知已读
```http
PUT /api/user/notifications/{notification_id}/read
```

#### 标记所有通知已读
```http
PUT /api/user/notifications/read-all
```

### 用户关注

#### 获取关注列表
```http
GET /api/user/follows?page=1&per_page=10
```

#### 关注用户
```http
POST /api/user/follows
Content-Type: application/json

{
  "following_id": 2
}
```

#### 取消关注
```http
DELETE /api/user/follows/{following_id}
```

### 私信管理

#### 获取私信列表
```http
GET /api/user/messages?user_id=2&page=1&per_page=10
```

#### 发送私信
```http
POST /api/user/messages
Content-Type: application/json

{
  "receiver_id": 2,
  "content": "私信内容",
  "message_type": "text"
}
```

### 活动记录

#### 获取活动记录
```http
GET /api/user/activities?type=login&page=1&per_page=10
```

#### 添加活动记录
```http
POST /api/user/activities
Content-Type: application/json

{
  "activity_type": "search",
  "description": "搜索茶叶",
  "activity_data": {
    "keyword": "龙井",
    "result_count": 10
  }
}
```

## 前端集成

### 1. 引入用户系统模块

```javascript
const { userSystem } = require('../../utils/user-system.js')
```

### 2. 初始化用户系统

```javascript
// 在页面onLoad中初始化
async onLoad() {
  // 初始化用户系统
  await userSystem.init()
  
  // 检查登录状态
  if (!userSystem.isLoggedIn()) {
    wx.navigateTo({
      url: '/pages/login/login'
    })
    return
  }
  
  // 加载用户数据
  await this.loadUserData()
}
```

### 3. 用户资料管理

```javascript
// 获取用户资料
async loadUserProfile() {
  const profile = userSystem.userProfile
  if (profile) {
    this.setData({
      nickname: profile.nickname,
      avatar: profile.avatar,
      email: profile.email,
      phone: profile.phone
    })
  }
}

// 更新用户资料
async updateProfile() {
  const profileData = {
    nickname: this.data.nickname,
    email: this.data.email,
    phone: this.data.phone
  }
  
  const success = await userSystem.updateUserProfile(profileData)
  if (success) {
    wx.showToast({
      title: '更新成功',
      icon: 'success'
    })
  }
}
```

### 4. 收藏功能

```javascript
// 添加收藏
async addToFavorites(itemType, itemId, title, description) {
  const success = await userSystem.addFavorite(itemType, itemId, title, description)
  if (success) {
    // 更新UI状态
    this.setData({
      isFavorited: true
    })
  }
}

// 取消收藏
async removeFromFavorites(favoriteId) {
  const success = await userSystem.removeFavorite(favoriteId)
  if (success) {
    // 更新UI状态
    this.setData({
      isFavorited: false
    })
  }
}

// 检查收藏状态
async checkFavoriteStatus(itemType, itemId) {
  const isFavorited = await userSystem.isFavorited(itemType, itemId)
  this.setData({
    isFavorited: isFavorited
  })
}
```

### 5. 浏览历史

```javascript
// 添加浏览历史
async addToHistory(itemType, itemId, title, description) {
  await userSystem.addHistory(itemType, itemId, title, description)
}

// 在页面显示时记录历史
onShow() {
  // 记录浏览历史
  this.addToHistory('market', this.data.marketId, this.data.marketName, this.data.marketDescription)
}
```

### 6. 消息通知

```javascript
// 加载通知列表
async loadNotifications() {
  await userSystem.loadNotifications()
  const notifications = userSystem.notifications
  
  this.setData({
    notifications: notifications,
    unreadCount: userSystem.getUnreadNotificationCount()
  })
}

// 标记通知已读
async markNotificationRead(notificationId) {
  await userSystem.markNotificationRead(notificationId)
  // 更新未读数量
  this.setData({
    unreadCount: userSystem.getUnreadNotificationCount()
  })
}

// 标记所有通知已读
async markAllNotificationsRead() {
  await userSystem.markAllNotificationsRead()
  this.setData({
    unreadCount: 0
  })
}
```

### 7. 用户关注

```javascript
// 关注用户
async followUser(userId) {
  const success = await userSystem.addFollow(userId)
  if (success) {
    this.setData({
      isFollowing: true
    })
  }
}

// 取消关注
async unfollowUser(userId) {
  const success = await userSystem.removeFollow(userId)
  if (success) {
    this.setData({
      isFollowing: false
    })
  }
}

// 检查关注状态
async checkFollowStatus(userId) {
  const isFollowing = await userSystem.isFollowing(userId)
  this.setData({
    isFollowing: isFollowing
  })
}
```

### 8. 私信功能

```javascript
// 发送私信
async sendMessage(receiverId, content) {
  const success = await userSystem.sendMessage(receiverId, content, 'text')
  if (success) {
    // 清空输入框
    this.setData({
      messageContent: ''
    })
  }
}

// 加载私信列表
async loadMessages(userId = null) {
  const options = userId ? { user_id: userId } : {}
  const messages = await userSystem.loadMessages(options)
  
  this.setData({
    messages: messages
  })
}
```

### 9. 活动记录

```javascript
// 记录用户活动
async recordActivity(activityType, description, activityData) {
  await userSystem.recordActivity(activityType, description, activityData)
}

// 示例：记录搜索活动
async recordSearchActivity(keyword, resultCount) {
  await this.recordActivity('search', `搜索关键词: ${keyword}`, {
    keyword: keyword,
    result_count: resultCount,
    timestamp: new Date().toISOString()
  })
}
```

## 页面集成示例

### 1. 个人中心页面

```javascript
// pages/profile/profile.js
const { userSystem } = require('../../utils/user-system.js')

Page({
  data: {
    userProfile: null,
    stats: {},
    notifications: [],
    unreadCount: 0
  },

  async onLoad() {
    await userSystem.init()
    await this.loadUserData()
  },

  async loadUserData() {
    // 加载用户资料
    this.setData({
      userProfile: userSystem.userProfile
    })

    // 加载统计信息
    this.setData({
      stats: userSystem.getStats()
    })

    // 加载通知
    await userSystem.loadNotifications()
    this.setData({
      notifications: userSystem.notifications.slice(0, 5),
      unreadCount: userSystem.getUnreadNotificationCount()
    })
  },

  // 编辑资料
  editProfile() {
    wx.navigateTo({
      url: '/pages/profile/edit-profile'
    })
  },

  // 我的收藏
  goToFavorites() {
    wx.navigateTo({
      url: '/pages/profile/favorites'
    })
  },

  // 浏览历史
  goToHistory() {
    wx.navigateTo({
      url: '/pages/profile/history'
    })
  },

  // 消息通知
  goToNotifications() {
    wx.navigateTo({
      url: '/pages/profile/notifications'
    })
  }
})
```

### 2. 商品详情页面

```javascript
// pages/market-detail/market-detail.js
const { userSystem } = require('../../utils/user-system.js')

Page({
  data: {
    marketId: null,
    marketData: null,
    isFavorited: false
  },

  async onLoad(options) {
    this.setData({
      marketId: options.id
    })
    
    await userSystem.init()
    await this.loadMarketDetail()
    await this.checkFavoriteStatus()
  },

  async onShow() {
    // 记录浏览历史
    if (this.data.marketData) {
      await userSystem.addHistory(
        'market',
        this.data.marketId,
        this.data.marketData.name,
        this.data.marketData.description
      )
    }
  },

  async loadMarketDetail() {
    // 加载市场详情
    const response = await API.getMarketDetail(this.data.marketId)
    if (response.status === 'success') {
      this.setData({
        marketData: response.data
      })
    }
  },

  async checkFavoriteStatus() {
    const isFavorited = await userSystem.isFavorited('market', this.data.marketId)
    this.setData({
      isFavorited: isFavorited
    })
  },

  // 收藏/取消收藏
  async toggleFavorite() {
    if (this.data.isFavorited) {
      // 取消收藏
      const favorite = userSystem.favorites.find(f => 
        f.item_type === 'market' && f.item_id === this.data.marketId
      )
      if (favorite) {
        await userSystem.removeFavorite(favorite.id)
      }
    } else {
      // 添加收藏
      await userSystem.addFavorite(
        'market',
        this.data.marketId,
        this.data.marketData.name,
        this.data.marketData.description
      )
    }
    
    this.setData({
      isFavorited: !this.data.isFavorited
    })
  }
})
```

## 数据模型说明

### 用户资料表 (UserProfile)
- `user_id`: 用户ID（外键）
- `nickname`: 昵称
- `avatar`: 头像URL
- `phone`: 手机号
- `email`: 邮箱
- `gender`: 性别
- `birthday`: 生日
- `location`: 所在地
- `company`: 公司
- `position`: 职位
- `bio`: 个人简介
- `preferences`: 用户偏好（JSON格式）

### 用户收藏表 (UserFavorite)
- `user_id`: 用户ID
- `item_type`: 收藏类型
- `item_id`: 收藏项目ID
- `title`: 标题
- `description`: 描述
- `created_at`: 创建时间

### 用户浏览历史表 (UserHistory)
- `user_id`: 用户ID
- `item_type`: 内容类型
- `item_id`: 内容ID
- `title`: 标题
- `description`: 描述
- `viewed_at`: 浏览时间

### 用户通知表 (UserNotification)
- `user_id`: 用户ID
- `type`: 通知类型
- `title`: 通知标题
- `content`: 通知内容
- `is_read`: 是否已读
- `priority`: 优先级
- `action_url`: 操作链接
- `created_at`: 创建时间

### 用户关注表 (UserFollow)
- `follower_id`: 关注者ID
- `following_id`: 被关注者ID
- `created_at`: 关注时间

### 用户私信表 (UserMessage)
- `sender_id`: 发送者ID
- `receiver_id`: 接收者ID
- `content`: 消息内容
- `is_read`: 是否已读
- `message_type`: 消息类型
- `created_at`: 发送时间

### 用户活动表 (UserActivity)
- `user_id`: 用户ID
- `activity_type`: 活动类型
- `description`: 活动描述
- `activity_data`: 活动数据（JSON格式）
- `ip_address`: IP地址
- `user_agent`: 用户代理
- `created_at`: 活动时间

## 最佳实践

### 1. 性能优化
- 使用本地缓存减少API请求
- 实现数据分页加载
- 合理使用索引优化查询

### 2. 用户体验
- 提供加载状态提示
- 实现错误处理和重试机制
- 支持离线模式

### 3. 数据安全
- 验证用户权限
- 防止重复操作
- 记录操作日志

### 4. 扩展性
- 模块化设计
- 支持插件扩展
- 版本兼容性

## 常见问题

### Q: 如何处理用户未登录的情况？
A: 在需要用户登录的功能中，先检查登录状态，未登录时跳转到登录页面。

### Q: 如何优化收藏功能的性能？
A: 使用本地缓存存储收藏状态，减少服务器请求。

### Q: 如何处理大量历史记录？
A: 实现分页加载和定期清理机制。

### Q: 如何实现实时通知？
A: 可以使用WebSocket或轮询机制实现实时通知。

## 更新日志

### v1.0.0 (2024-01-20)
- 初始版本发布
- 实现基础用户系统功能
- 支持用户资料、收藏、历史、通知等功能

### 计划功能
- 用户等级系统
- 积分奖励机制
- 社交分享功能
- 个性化推荐
- 数据分析面板 