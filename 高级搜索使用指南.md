# 高级搜索和筛选功能使用指南

## 📖 功能概述

高级搜索和筛选功能为茶叶一点通平台提供了强大的数据检索能力，支持多条件组合搜索、价格范围筛选、时间范围筛选等多种高级功能。

## 🚀 核心特性

### ✅ 已实现功能
- **多条件组合搜索** - 支持关键词、分类、类型、省份等多维度筛选
- **价格范围筛选** - 支持精确价格和价格区间搜索
- **时间范围筛选** - 支持创建时间范围筛选
- **智能分页** - 支持分页加载和结果统计
- **筛选选项动态获取** - 根据数据类型动态获取可用筛选选项
- **离线降级** - 网络异常时自动使用本地数据
- **性能优化** - 支持缓存和并发请求优化

### 🎯 支持的数据类型
- **市场数据** (`markets`) - 茶叶市场信息
- **新品数据** (`newarrivals`) - 新品到货信息
- **供求数据** (`supplies`) - 供应和需求信息
- **清仓数据** (`clearance`) - 清仓特价信息
- **内容数据** (`content`) - 文章和资讯内容

## 🔧 API接口说明

### 1. 高级搜索接口

#### 市场高级搜索
```javascript
// 基础用法
const response = await API.advancedSearchMarkets({
  keyword: '茶叶市场',
  province: '福建省',
  dateRange: '2024-01-01-2024-12-31'
})

// 完整参数
const response = await API.advancedSearchMarkets({
  keyword: '茶叶',           // 关键词搜索
  province: '福建省',        // 省份筛选
  dateRange: '2024-01-01-2024-12-31', // 时间范围
  page: 1,                   // 页码
  perPage: 20                // 每页数量
})
```

#### 新品高级搜索
```javascript
const response = await API.advancedSearchNewarrivals({
  keyword: '龙井茶',         // 关键词搜索
  category: '绿茶',          // 分类筛选
  priceRange: '100-500',     // 价格范围
  dateRange: '2024-01-01-2024-12-31' // 时间范围
})
```

#### 供求高级搜索
```javascript
const response = await API.advancedSearchSupplies({
  keyword: '铁观音',         // 关键词搜索
  type: '供应',              // 类型筛选
  priceRange: '200-1000',    // 价格范围
  status: 'active'           // 状态筛选
})
```

#### 清仓高级搜索
```javascript
const response = await API.advancedSearchClearance({
  keyword: '普洱茶',         // 关键词搜索
  category: '普洱茶',        // 分类筛选
  priceRange: '50-300'       // 价格范围
})
```

#### 内容高级搜索
```javascript
const response = await API.advancedSearchContent({
  keyword: '茶艺',           // 关键词搜索
  type: 'art',               // 内容类型
  tag: '冲泡技巧'            // 标签筛选
})
```

### 2. 筛选选项获取接口

```javascript
// 获取所有筛选选项
const response = await API.getFilterOptions('all')

// 获取特定类型的筛选选项
const response = await API.getFilterOptions('markets')
const response = await API.getFilterOptions('newarrivals')
const response = await API.getFilterOptions('supplies')
const response = await API.getFilterOptions('clearance')
const response = await API.getFilterOptions('content')
```

### 3. 参数构建工具

```javascript
// 使用参数构建工具
const filters = API.buildAdvancedFilters({
  keyword: '龙井茶',
  category: '绿茶',
  priceRange: '100-500',
  dateRange: '2024-01-01-2024-12-31',
  province: '浙江省',
  type: '供应',
  tag: '新品推荐',
  status: 'active',
  page: 1,
  perPage: 20
})

// 然后使用构建的参数进行搜索
const response = await API.advancedSearchNewarrivals(filters)
```

## 📋 参数格式说明

### 关键词搜索 (`keyword`)
- **类型**: 字符串
- **说明**: 支持模糊搜索，会在标题、描述、内容等字段中查找
- **示例**: `'龙井茶'`, `'茶叶市场'`

### 分类筛选 (`category`)
- **类型**: 字符串
- **说明**: 精确匹配分类名称
- **示例**: `'绿茶'`, `'红茶'`, `'普洱茶'`

### 类型筛选 (`type`)
- **类型**: 字符串
- **说明**: 精确匹配类型名称
- **示例**: `'供应'`, `'求购'`, `'recommend'`, `'news'`

### 省份筛选 (`province`)
- **类型**: 字符串
- **说明**: 精确匹配省份名称
- **示例**: `'福建省'`, `'浙江省'`, `'云南省'`

### 价格范围筛选 (`priceRange`)
- **类型**: 字符串
- **格式**: `'最小值-最大值'` 或 `'精确价格'`
- **说明**: 支持价格区间和精确价格搜索
- **示例**: 
  - `'100-500'` - 价格在100到500之间
  - `'300'` - 价格等于300
  - `'100-'` - 价格大于等于100
  - `'-500'` - 价格小于等于500

### 时间范围筛选 (`dateRange`)
- **类型**: 字符串
- **格式**: `'开始日期-结束日期'` 或 `'具体日期'`
- **说明**: 支持日期区间和具体日期搜索
- **示例**:
  - `'2024-01-01-2024-12-31'` - 2024年全年
  - `'2024-01-01'` - 2024年1月1日
  - `'2024-01-01-'` - 2024年1月1日之后
  - `'-2024-12-31'` - 2024年12月31日之前

### 标签筛选 (`tag`)
- **类型**: 字符串
- **说明**: 精确匹配标签名称
- **示例**: `'新品推荐'`, `'冲泡技巧'`, `'市场分析'`

### 状态筛选 (`status`)
- **类型**: 字符串
- **说明**: 精确匹配状态名称
- **示例**: `'active'`, `'inactive'`, `'hot'`

### 分页参数
- **page**: 页码，从1开始
- **perPage**: 每页数量，最大100

## 🎨 前端组件使用

### 1. 引入高级搜索组件

```javascript
const AdvancedSearch = require('../../utils/advanced-search.js')

Page({
  data: {
    list: [],
    hasMore: true,
    currentFilters: {}
  },

  onLoad() {
    // 初始化高级搜索组件
    this.advancedSearch = AdvancedSearch
    this.advancedSearch.init(this, 'markets') // 指定数据类型
  }
})
```

### 2. 在页面中使用

```html
<!-- 搜索表单 -->
<view class="search-form">
  <input 
    placeholder="搜索关键词" 
    bindinput="onKeywordInput"
    data-filter="keyword"
  />
  
  <picker 
    mode="selector" 
    range="{{provinces}}" 
    bindchange="onProvinceChange"
    data-filter="province"
  >
    <view>选择省份</view>
  </picker>
  
  <input 
    placeholder="价格范围，如：100-500" 
    bindinput="onPriceRangeInput"
    data-filter="priceRange"
  />
  
  <picker 
    mode="date" 
    bindchange="onDateRangeChange"
    data-filter="dateRange"
  >
    <view>选择日期</view>
  </picker>
  
  <button bindtap="onSearch">搜索</button>
  <button bindtap="onReset">重置</button>
</view>

<!-- 搜索结果 -->
<view class="search-results">
  <view wx:for="{{list}}" wx:key="id" class="result-item">
    <text>{{item.name || item.title}}</text>
  </view>
</view>
```

### 3. 事件处理

```javascript
Page({
  // 关键词输入
  onKeywordInput(e) {
    this.setData({
      'currentFilters.keyword': e.detail.value
    })
  },

  // 省份选择
  onProvinceChange(e) {
    const provinces = this.data.provinces
    this.setData({
      'currentFilters.province': provinces[e.detail.value]
    })
  },

  // 价格范围输入
  onPriceRangeInput(e) {
    this.setData({
      'currentFilters.priceRange': e.detail.value
    })
  },

  // 日期范围选择
  onDateRangeChange(e) {
    this.setData({
      'currentFilters.dateRange': e.detail.value
    })
  },

  // 执行搜索
  async onSearch() {
    try {
      wx.showLoading({ title: '搜索中...' })
      
      const filters = API.buildAdvancedFilters(this.data.currentFilters)
      const response = await API.advancedSearchMarkets(filters)
      
      if (response.status === 'success') {
        this.setData({
          list: response.data,
          hasMore: response.data.length > 0
        })
        
        wx.showToast({
          title: `找到 ${response.pagination.total} 条结果`,
          icon: 'none'
        })
      }
    } catch (error) {
      wx.showToast({
        title: '搜索失败',
        icon: 'none'
      })
    } finally {
      wx.hideLoading()
    }
  },

  // 重置搜索
  onReset() {
    this.setData({
      currentFilters: {}
    })
    this.onSearch()
  }
})
```

## 🔍 搜索示例

### 示例1: 搜索福建省的茶叶市场
```javascript
const response = await API.advancedSearchMarkets({
  keyword: '茶叶',
  province: '福建省'
})
```

### 示例2: 搜索100-500元的绿茶新品
```javascript
const response = await API.advancedSearchNewarrivals({
  keyword: '龙井',
  category: '绿茶',
  priceRange: '100-500'
})
```

### 示例3: 搜索2024年的供应信息
```javascript
const response = await API.advancedSearchSupplies({
  type: '供应',
  dateRange: '2024-01-01-2024-12-31',
  status: 'active'
})
```

### 示例4: 搜索茶艺相关文章
```javascript
const response = await API.advancedSearchContent({
  keyword: '茶艺',
  type: 'art',
  tag: '冲泡技巧'
})
```

### 示例5: 复杂组合搜索
```javascript
const response = await API.advancedSearchNewarrivals({
  keyword: '茶',
  category: '绿茶',
  priceRange: '50-1000',
  dateRange: '2024-01-01-2024-12-31',
  page: 1,
  perPage: 20
})
```

## ⚡ 性能优化建议

### 1. 合理使用筛选条件
- 优先使用精确匹配的筛选条件（如分类、类型、省份）
- 关键词搜索作为补充，避免过于宽泛的关键词
- 合理设置价格和时间范围，避免范围过大

### 2. 分页加载
- 使用分页参数控制每次加载的数据量
- 建议每页20-50条数据
- 实现"加载更多"功能而不是一次性加载所有数据

### 3. 缓存策略
- 对筛选选项进行缓存，避免重复请求
- 对搜索结果进行短期缓存
- 使用API管理器的缓存功能

### 4. 用户体验优化
- 搜索时显示加载状态
- 提供搜索建议和自动完成
- 保存用户的搜索历史
- 提供快速筛选按钮

## 🛠️ 错误处理

### 常见错误及解决方案

#### 1. 参数格式错误
```javascript
// 错误的价格范围格式
const response = await API.advancedSearchNewarrivals({
  priceRange: 'invalid-price' // 错误格式
})

// 正确的价格范围格式
const response = await API.advancedSearchNewarrivals({
  priceRange: '100-500' // 正确格式
})
```

#### 2. 网络连接错误
```javascript
try {
  const response = await API.advancedSearchMarkets(filters)
  // 处理成功响应
} catch (error) {
  if (error.message.includes('连接失败')) {
    // 使用离线数据或显示错误提示
    wx.showToast({
      title: '网络连接失败，使用离线数据',
      icon: 'none'
    })
  }
}
```

#### 3. 服务器错误
```javascript
const response = await API.advancedSearchMarkets(filters)
if (response.status === 'error') {
  wx.showToast({
    title: response.message || '搜索失败',
    icon: 'none'
  })
}
```

## 📊 测试和调试

### 1. 使用测试脚本
```javascript
// 运行测试脚本
const testScript = require('./测试高级搜索功能.js')
testScript.runAllTests()
```

### 2. 调试技巧
- 使用 `console.log` 输出搜索参数和结果
- 检查网络请求的URL和参数
- 验证筛选选项是否正确加载
- 测试边界情况和异常输入

### 3. 性能监控
- 监控搜索响应时间
- 检查内存使用情况
- 观察网络请求频率
- 分析用户搜索行为

## 🔮 未来扩展

### 计划中的功能
- **地理位置搜索** - 基于用户位置的附近搜索
- **智能推荐** - 基于用户行为的搜索建议
- **语音搜索** - 支持语音输入搜索
- **图片搜索** - 支持图片识别搜索
- **高级排序** - 支持多种排序方式
- **搜索历史** - 保存和管理搜索历史
- **收藏搜索** - 保存常用搜索条件

---

**文档版本**: v1.0.0  
**最后更新**: 2025-07-17  
**维护者**: AI Assistant 