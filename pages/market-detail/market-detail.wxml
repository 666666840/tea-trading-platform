<view class="container">
  <!-- 入驻按钮 - 始终显示 -->
  <view class="join-market-section">
    <button class="join-market-btn" bindtap="showJoinForm">
      <text class="join-icon">🏪</text>
      <text class="join-text">申请入驻此市场</text>
    </button>
    <view class="join-actions">
      <text class="join-tip">已有{{marketInfo.merchantCount || 0}}家商户入驻</text>
      <text class="guide-link" bindtap="viewJoinGuide">查看入驻指南</text>
    </view>
  </view>

  <!-- 市场信息头部 -->
  <view class="market-header" wx:if="{{marketInfo}}">
    <!-- 调试信息 -->
    <view class="debug-info" style="background: #f0f0f0; padding: 10rpx; margin-bottom: 10rpx; font-size: 24rpx; color: #666;">
      调试信息: marketId={{marketId}}, marketInfo存在={{marketInfo ? '是' : '否'}}
    </view>
    
    <view class="market-basic">
      <view class="market-title">
        <text class="market-name">{{marketInfo.name}}</text>
        <view class="market-level">{{marketInfo.level}}</view>
      </view>
      <text class="market-location">{{marketInfo.location}}</text>
      <text class="market-description">{{marketInfo.description}}</text>
    </view>
    
    <view class="market-stats">
      <view class="stat-item">
        <text class="stat-value">{{marketInfo.merchantCount}}</text>
        <text class="stat-label">入驻商户</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{marketInfo.specialties.length}}</text>
        <text class="stat-label">主营品类</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{marketInfo.established}}</text>
        <text class="stat-label">成立时间</text>
      </view>
    </view>
    
    <view class="market-specialties">
      <text class="specialty-tag" wx:for="{{marketInfo.specialties}}" wx:key="*this">{{item}}</text>
    </view>
  </view>

  <!-- 如果marketInfo不存在，显示加载状态和入驻按钮 -->
  <view class="market-header" wx:if="{{!marketInfo}}">
    <view class="loading-market">
      <text class="loading-text">正在加载市场信息...</text>
    </view>
  </view>

  <!-- 市场详细信息 -->
  <view class="market-details" wx:if="{{marketInfo}}">
    <view class="detail-section">
      <view class="section-title">基本信息</view>
      <view class="detail-item">
        <text class="detail-label">详细地址：</text>
        <text class="detail-value">{{marketInfo.address}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">联系电话：</text>
        <text class="detail-value">{{marketInfo.contact}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">营业时间：</text>
        <text class="detail-value">{{marketInfo.businessHours}}</text>
      </view>
    </view>
    
    <view class="detail-section">
      <view class="section-title">配套设施</view>
      <view class="facilities">
        <text class="facility-tag" wx:for="{{marketInfo.facilities}}" wx:key="*this">{{item}}</text>
      </view>
    </view>
  </view>

  <!-- 商户搜索和筛选 -->
  <view class="merchant-controls">
    <view class="search-bar">
      <view class="search-input">
        <text class="search-icon">🔍</text>
        <input placeholder="搜索商户名称或产品" bindinput="onSearchInput" />
      </view>
    </view>
    
    <view class="filter-bar">
      <view class="filter-item {{filterType === 'all' ? 'active' : ''}}" 
            bindtap="setFilter" data-type="all">
        全部
      </view>
      <view class="filter-item {{filterType === 'active' ? 'active' : ''}}" 
            bindtap="setFilter" data-type="active">
        活跃商户
      </view>
      <view class="filter-item {{filterType === 'verified' ? 'active' : ''}}" 
            bindtap="setFilter" data-type="verified">
        认证商户
      </view>
    </view>
    
    <view class="sort-bar">
      <view class="sort-item {{sortType === 'comprehensive' ? 'active' : ''}}" 
            bindtap="setSortType" data-type="comprehensive">
        综合推荐
      </view>
      <view class="sort-item {{sortType === 'newest' ? 'active' : ''}}" 
            bindtap="setSortType" data-type="newest">
        最新入驻
      </view>
      <view class="sort-item {{sortType === 'activity' ? 'active' : ''}}" 
            bindtap="setSortType" data-type="activity">
        活跃度
      </view>
    </view>
  </view>

  <!-- 商户列表 -->
  <view class="merchant-list" wx:if="{{filteredMerchants.length > 0}}">
    <view class="merchant-item" 
          wx:for="{{filteredMerchants}}" 
          wx:key="id"
          bindtap="viewMerchantDetail" 
          data-id="{{item.id}}">
      
      <view class="merchant-header">
        <image class="merchant-logo" src="{{item.logo}}" mode="aspectFill"></image>
        <view class="merchant-info">
          <view class="merchant-name">
            <text>{{item.name}}</text>
            <view class="verification-badge" wx:if="{{item.verified}}">✓</view>
          </view>
          <view class="merchant-products">
            <text class="product-tag" wx:for="{{item.mainProducts}}" wx:key="*this">{{item}}</text>
          </view>
        </view>
        <view class="merchant-status">
          <view class="activity-status {{item.activityLevel}}">
            {{item.activityText}}
          </view>
          <view class="rating">
            ⭐ {{item.rating}}
          </view>
        </view>
      </view>
      
      <view class="merchant-content">
        <text class="merchant-description">{{item.description}}</text>
        <view class="merchant-meta">
          <text class="meta-item">响应时间：{{item.responseTime}}</text>
          <text class="meta-item">最后活跃：{{item.lastActive}}</text>
        </view>
      </view>
      
      <view class="merchant-actions">
        <button class="action-btn contact-btn" 
                bindtap="contactMerchant" 
                data-merchant="{{item}}"
                catchtap="true">
          联系商户
        </button>
        <button class="action-btn detail-btn" 
                bindtap="viewMerchantDetail" 
                data-id="{{item.id}}"
                catchtap="true">
          查看详情
        </button>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{filteredMerchants.length === 0 && !loading}}">
    <view class="empty-icon">🏪</view>
    <text class="empty-text">暂无商户信息</text>
  </view>

  <!-- 加载状态 -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-icon">⏳</view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 加载更多 -->
  <view class="load-more" wx:if="{{hasMore && !loading && filteredMerchants.length > 0}}">
    <text bindtap="loadMore">加载更多商户</text>
  </view>

  <!-- 入驻申请弹窗 -->
  <view class="modal-overlay" wx:if="{{showJoinModal}}" bindtap="closeJoinForm">
    <view class="modal-content join-form" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">申请入驻{{marketInfo.name}}</text>
        <text class="modal-close" bindtap="closeJoinForm">×</text>
      </view>
      
      <view class="modal-body">
        <!-- 入驻流程说明 -->
        <view class="join-process">
          <view class="process-step">
            <text class="step-number">1</text>
            <text class="step-text">填写基本信息</text>
          </view>
          <view class="process-step">
            <text class="step-number">2</text>
            <text class="step-text">上传资质证明</text>
          </view>
          <view class="process-step">
            <text class="step-number">3</text>
            <text class="step-text">等待审核通过</text>
          </view>
        </view>

        <!-- 入驻表单 -->
        <view class="form-section">
          <text class="form-label">商户信息</text>
          <input class="form-input" 
                 placeholder="商户名称" 
                 value="{{joinForm.merchantName}}"
                 data-field="merchantName"
                 bindinput="inputJoinForm" />
          <input class="form-input" 
                 placeholder="联系人姓名" 
                 value="{{joinForm.contactName}}"
                 data-field="contactName"
                 bindinput="inputJoinForm" />
          <input class="form-input" 
                 placeholder="联系电话" 
                 value="{{joinForm.phone}}"
                 data-field="phone"
                 bindinput="inputJoinForm" />
          <input class="form-input" 
                 placeholder="微信号" 
                 value="{{joinForm.wechat}}"
                 data-field="wechat"
                 bindinput="inputJoinForm" />
        </view>

        <view class="form-section">
          <text class="form-label">经营信息</text>
          <picker class="form-picker"
                  mode="selector"
                  range="{{businessTypes}}"
                  bindchange="onBusinessTypeChange">
            <view class="picker-text">
              {{joinForm.businessType || '请选择经营类型'}}
            </view>
          </picker>
          <picker class="form-picker"
                  mode="selector"
                  range="{{mainCategories}}"
                  bindchange="onCategoryChange">
            <view class="picker-text">
              {{joinForm.mainCategory || '请选择主营品类'}}
            </view>
          </picker>
          <textarea class="form-textarea" 
                    placeholder="经营描述（选填）"
                    value="{{joinForm.description}}"
                    data-field="description"
                    bindinput="inputJoinForm"></textarea>
        </view>

        <view class="form-section">
          <text class="form-label">资质证明</text>
          <view class="upload-section">
            <view class="upload-item" bindtap="uploadLicense">
              <text class="upload-icon">📄</text>
              <text class="upload-text">营业执照</text>
              <text class="upload-status" wx:if="{{joinForm.license}}">✓ 已上传</text>
            </view>
            <view class="upload-item" bindtap="uploadIDCard">
              <text class="upload-icon">🆔</text>
              <text class="upload-text">身份证</text>
              <text class="upload-status" wx:if="{{joinForm.idCard}}">✓ 已上传</text>
            </view>
          </view>
        </view>

        <view class="form-tips">
          <text class="tip-text">• 请确保信息真实有效</text>
          <text class="tip-text">• 平台将在3个工作日内审核</text>
          <text class="tip-text">• 审核通过后可发布商品信息</text>
          <text class="tip-text">• 入驻费用：{{marketInfo.level === '国家级' ? '500元/年' : '300元/年'}}</text>
        </view>
        
        <view class="form-actions">
          <button class="cancel-btn" bindtap="closeJoinForm">取消</button>
          <button class="submit-btn" bindtap="submitJoinForm">提交申请</button>
        </view>
      </view>
    </view>
  </view>
</view> 