<!--æ•°æ®åˆ†æé¡µé¢-->
<view class="analytics-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-title">
      <text class="title-text">ğŸ“Š æ•°æ®åˆ†æ</text>
      <text class="subtitle-text">å®æ—¶ç›‘æ§å¹³å°æ•°æ®è¡¨ç°</text>
    </view>
    
    <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
    <view class="time-range-selector">
      <view class="range-buttons">
        <button 
          class="range-btn {{timeRange === '7d' ? 'active' : ''}}" 
          data-range="7d" 
          bindtap="switchTimeRange"
        >7å¤©</button>
        <button 
          class="range-btn {{timeRange === '30d' ? 'active' : ''}}" 
          data-range="30d" 
          bindtap="switchTimeRange"
        >30å¤©</button>
        <button 
          class="range-btn {{timeRange === '90d' ? 'active' : ''}}" 
          data-range="90d" 
          bindtap="switchTimeRange"
        >90å¤©</button>
      </view>
      
      <!-- è‡ªå®šä¹‰æ—¥æœŸ -->
      <view class="custom-date">
        <picker mode="date" value="{{customStartDate}}" bindchange="onStartDateChange">
          <view class="date-picker">
            <text class="date-label">å¼€å§‹:</text>
            <text class="date-value">{{customStartDate}}</text>
          </view>
        </picker>
        <picker mode="date" value="{{customEndDate}}" bindchange="onEndDateChange">
          <view class="date-picker">
            <text class="date-label">ç»“æŸ:</text>
            <text class="date-value">{{customEndDate}}</text>
          </view>
        </picker>
        <button class="apply-btn" bindtap="applyCustomDate">åº”ç”¨</button>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-navigation">
    <view 
      class="tab-item {{activeTab === 'dashboard' ? 'active' : ''}}" 
      data-tab="dashboard" 
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ“ˆ</text>
      <text class="tab-text">ä»ªè¡¨æ¿</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'users' ? 'active' : ''}}" 
      data-tab="users" 
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ‘¥</text>
      <text class="tab-text">ç”¨æˆ·è¡Œä¸º</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'content' ? 'active' : ''}}" 
      data-tab="content" 
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ“</text>
      <text class="tab-text">å†…å®¹è¡¨ç°</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'search' ? 'active' : ''}}" 
      data-tab="search" 
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ”</text>
      <text class="tab-text">æœç´¢åˆ†æ</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'events' ? 'active' : ''}}" 
      data-tab="events" 
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ“‹</text>
      <text class="tab-text">äº‹ä»¶è¿½è¸ª</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'reports' ? 'active' : ''}}" 
      data-tab="reports" 
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ“Š</text>
      <text class="tab-text">æŠ¥å‘Š</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ•°æ®åŠ è½½ä¸­...</text>
  </view>

  <!-- ä»ªè¡¨æ¿æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'dashboard' && !loading}}">
    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <view class="overview-cards">
      <view class="overview-card">
        <view class="card-header">
          <text class="card-icon">ğŸ“Š</text>
          <text class="card-title">æ€»äº‹ä»¶æ•°</text>
        </view>
        <text class="card-value">{{formatNumber(dashboard.overview.totalEvents)}}</text>
        <text class="card-trend {{getTrendIcon(dashboard.trends.trendDirection)}}">
          {{getTrendIcon(dashboard.trends.trendDirection)}}
        </text>
      </view>
      
      <view class="overview-card">
        <view class="card-header">
          <text class="card-icon">ğŸ‘¥</text>
          <text class="card-title">ç‹¬ç«‹ç”¨æˆ·</text>
        </view>
        <text class="card-value">{{formatNumber(dashboard.overview.uniqueUsers)}}</text>
      </view>
      
      <view class="overview-card">
        <view class="card-header">
          <text class="card-icon">ğŸ”„</text>
          <text class="card-title">ä¼šè¯æ•°</text>
        </view>
        <text class="card-value">{{formatNumber(dashboard.overview.uniqueSessions)}}</text>
      </view>
      
      <view class="overview-card">
        <view class="card-header">
          <text class="card-icon">ğŸ‘ï¸</text>
          <text class="card-title">å†…å®¹æµè§ˆ</text>
        </view>
        <text class="card-value">{{formatNumber(dashboard.overview.totalContentViews)}}</text>
      </view>
    </view>

    <!-- ç”¨æˆ·è¡Œä¸ºåˆ†æ -->
    <view class="analysis-section">
      <view class="section-header">
        <text class="section-title">ğŸ‘¥ ç”¨æˆ·è¡Œä¸ºåˆ†æ</text>
      </view>
      
      <!-- ç”¨æˆ·åˆ†æ®µ -->
      <view class="chart-container">
        <text class="chart-title">ç”¨æˆ·åˆ†æ®µåˆ†å¸ƒ</text>
        <view class="segment-chart">
          <view 
            class="segment-item" 
            wx:for="{{userBehavior.userSegments}}" 
            wx:key="segment"
          >
            <view class="segment-info">
              <view class="segment-color" style="background-color: {{getSegmentColor(item.segment)}}"></view>
              <text class="segment-name">{{item.segment}}</text>
              <text class="segment-count">{{item.count}}</text>
            </view>
            <view class="segment-bar">
              <view class="bar-fill" style="width: {{item.percentage}}%; background-color: {{getSegmentColor(item.segment)}}"></view>
            </view>
            <text class="segment-percentage">{{item.percentage}}%</text>
          </view>
        </view>
      </view>
      
      <!-- è®¾å¤‡ç±»å‹ -->
      <view class="chart-container">
        <text class="chart-title">è®¾å¤‡ç±»å‹åˆ†å¸ƒ</text>
        <view class="device-chart">
          <view 
            class="device-item" 
            wx:for="{{userBehavior.deviceTypes}}" 
            wx:key="device"
          >
            <text class="device-name">{{item.device}}</text>
            <text class="device-count">{{item.count}}</text>
            <text class="device-percentage">{{item.percentage}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å†…å®¹è¡¨ç°åˆ†æ -->
    <view class="analysis-section">
      <view class="section-header">
        <text class="section-title">ğŸ“ å†…å®¹è¡¨ç°åˆ†æ</text>
      </view>
      
      <!-- çƒ­é—¨å†…å®¹ -->
      <view class="content-list">
        <text class="list-title">çƒ­é—¨å†…å®¹ TOP 10</text>
        <view 
          class="content-item" 
          wx:for="{{contentPerformance.topContent}}" 
          wx:key="content_id"
          data-id="{{item.content_id}}"
          bindtap="viewContentDetail"
        >
          <view class="content-info">
            <text class="content-title">{{item.title}}</text>
            <text class="content-type">{{item.content_type}}</text>
          </view>
          <view class="content-stats">
            <text class="stat-item">ğŸ‘ï¸ {{item.views}}</text>
            <text class="stat-item">â­ {{item.performance_score}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æœç´¢æ´å¯Ÿ -->
    <view class="analysis-section">
      <view class="section-header">
        <text class="section-title">ğŸ” æœç´¢æ´å¯Ÿ</text>
      </view>
      
      <!-- çƒ­é—¨å…³é”®è¯ -->
      <view class="keyword-list">
        <text class="list-title">çƒ­é—¨æœç´¢å…³é”®è¯</text>
        <view 
          class="keyword-item" 
          wx:for="{{searchAnalytics.topKeywords}}" 
          wx:key="keyword"
        >
          <text class="keyword-text">{{item.keyword}}</text>
          <text class="keyword-count">{{item.count}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç”¨æˆ·è¡Œä¸ºæ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'users' && !loading}}">
    <view class="analysis-section">
      <view class="section-header">
        <text class="section-title">ğŸ‘¥ ç”¨æˆ·è¡Œä¸ºè¯¦ç»†åˆ†æ</text>
      </view>
      
      <!-- ç”¨æˆ·åˆ†æ®µè¯¦ç»† -->
      <view class="detail-chart">
        <text class="chart-title">ç”¨æˆ·åˆ†æ®µè¯¦ç»†åˆ†æ</text>
        <view class="segment-details">
          <view 
            class="segment-detail" 
            wx:for="{{userBehavior.userSegments}}" 
            wx:key="segment"
          >
            <view class="detail-header">
              <view class="segment-color" style="background-color: {{getSegmentColor(item.segment)}}"></view>
              <text class="segment-name">{{item.segment}}</text>
            </view>
            <view class="detail-stats">
              <text class="stat-label">ç”¨æˆ·æ•°:</text>
              <text class="stat-value">{{item.count}}</text>
            </view>
            <view class="detail-stats">
              <text class="stat-label">å æ¯”:</text>
              <text class="stat-value">{{item.percentage}}%</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- çƒ­é—¨é¡µé¢ -->
      <view class="page-list">
        <text class="list-title">çƒ­é—¨é¡µé¢è®¿é—®</text>
        <view 
          class="page-item" 
          wx:for="{{userBehavior.topPages}}" 
          wx:key="page"
        >
          <text class="page-path">{{item.page}}</text>
          <text class="page-count">{{item.count}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å†…å®¹è¡¨ç°æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'content' && !loading}}">
    <view class="analysis-section">
      <view class="section-header">
        <text class="section-title">ğŸ“ å†…å®¹è¡¨ç°è¯¦ç»†åˆ†æ</text>
      </view>
      
      <!-- å†…å®¹ç±»å‹åˆ†å¸ƒ -->
      <view class="content-type-chart">
        <text class="chart-title">å†…å®¹ç±»å‹åˆ†å¸ƒ</text>
        <view class="type-list">
          <view 
            class="type-item" 
            wx:for="{{contentPerformance.contentTypes}}" 
            wx:key="type"
          >
            <text class="type-name">{{item.type}}</text>
            <view class="type-bar">
              <view class="bar-fill" style="width: {{item.percentage}}%"></view>
            </view>
            <text class="type-count">{{item.count}}</text>
            <text class="type-percentage">{{item.percentage}}%</text>
          </view>
        </view>
      </view>
      
      <!-- å†…å®¹è¡¨ç°æ’è¡Œæ¦œ -->
      <view class="performance-ranking">
        <text class="list-title">å†…å®¹è¡¨ç°æ’è¡Œæ¦œ</text>
        <view 
          class="ranking-item" 
          wx:for="{{contentPerformance.topContent}}" 
          wx:key="content_id"
          data-id="{{item.content_id}}"
          bindtap="viewContentDetail"
        >
          <view class="ranking-number">{{index + 1}}</view>
          <view class="ranking-content">
            <text class="content-title">{{item.title}}</text>
            <text class="content-type">{{item.content_type}}</text>
          </view>
          <view class="ranking-stats">
            <text class="stat-item">ğŸ‘ï¸ {{item.views}}</text>
            <text class="stat-item">â­ {{item.performance_score}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æœç´¢åˆ†ææ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'search' && !loading}}">
    <view class="analysis-section">
      <view class="section-header">
        <text class="section-title">ğŸ” æœç´¢åˆ†æè¯¦ç»†æŠ¥å‘Š</text>
      </view>
      
      <!-- æœç´¢æ„å›¾åˆ†æ -->
      <view class="intent-analysis">
        <text class="chart-title">æœç´¢æ„å›¾åˆ†å¸ƒ</text>
        <view class="intent-chart">
          <view 
            class="intent-item" 
            wx:for="{{searchAnalytics.searchIntents}}" 
            wx:key="intent"
          >
            <view class="intent-info">
              <view class="intent-color" style="background-color: {{getIntentColor(item.intent)}}"></view>
              <text class="intent-name">{{item.intent}}</text>
              <text class="intent-count">{{item.count}}</text>
            </view>
            <view class="intent-bar">
              <view class="bar-fill" style="width: {{item.percentage}}%; background-color: {{getIntentColor(item.intent)}}"></view>
            </view>
            <text class="intent-percentage">{{item.percentage}}%</text>
          </view>
        </view>
      </view>
      
      <!-- çƒ­é—¨å…³é”®è¯è¯¦ç»† -->
      <view class="keyword-details">
        <text class="list-title">çƒ­é—¨æœç´¢å…³é”®è¯è¯¦ç»†</text>
        <view 
          class="keyword-detail" 
          wx:for="{{searchAnalytics.topKeywords}}" 
          wx:key="keyword"
        >
          <view class="keyword-info">
            <text class="keyword-text">{{item.keyword}}</text>
            <text class="keyword-count">{{item.count}}æ¬¡</text>
          </view>
          <view class="keyword-trend">
            <text class="trend-icon">ğŸ“ˆ</text>
            <text class="trend-text">ä¸Šå‡è¶‹åŠ¿</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- äº‹ä»¶è¿½è¸ªæ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'events' && !loading}}">
    <view class="analysis-section">
      <view class="section-header">
        <text class="section-title">ğŸ“‹ äº‹ä»¶è¿½è¸ªè®°å½•</text>
        <button class="refresh-btn" bindtap="refreshData">ğŸ”„ åˆ·æ–°</button>
      </view>
      
      <!-- äº‹ä»¶åˆ—è¡¨ -->
      <view class="events-list">
        <view 
          class="event-item" 
          wx:for="{{events.list}}" 
          wx:key="event_id"
          data-id="{{item.event_id}}"
          bindtap="viewEventDetail"
        >
          <view class="event-header">
            <text class="event-type">{{item.event_type}}</text>
            <text class="event-time">{{item.timestamp}}</text>
          </view>
          <view class="event-details">
            <text class="event-page">é¡µé¢: {{item.page}}</text>
            <text class="event-user" wx:if="{{item.user_id}}">ç”¨æˆ·: {{item.user_id}}</text>
          </view>
          <view class="event-meta" wx:if="{{item.item_title}}">
            <text class="event-item-title">{{item.item_title}}</text>
          </view>
        </view>
      </view>
      
      <!-- åˆ†é¡µ -->
      <view class="pagination" wx:if="{{events.pagination.pages > 1}}">
        <button 
          class="page-btn" 
          disabled="{{events.pagination.page <= 1}}"
          data-page="{{events.pagination.page - 1}}"
          bindtap="loadEvents"
        >ä¸Šä¸€é¡µ</button>
        <text class="page-info">{{events.pagination.page}} / {{events.pagination.pages}}</text>
        <button 
          class="page-btn" 
          disabled="{{events.pagination.page >= events.pagination.pages}}"
          data-page="{{events.pagination.page + 1}}"
          bindtap="loadEvents"
        >ä¸‹ä¸€é¡µ</button>
      </view>
    </view>
  </view>

  <!-- æŠ¥å‘Šæ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'reports' && !loading}}">
    <view class="analysis-section">
      <view class="section-header">
        <text class="section-title">ğŸ“Š æ•°æ®æŠ¥å‘Š</text>
      </view>
      
      <!-- æŠ¥å‘Šç”Ÿæˆ -->
      <view class="report-actions">
        <button 
          class="report-btn" 
          data-type="daily" 
          bindtap="generateReport"
        >ğŸ“… ç”Ÿæˆæ—¥æŠ¥</button>
        <button 
          class="report-btn" 
          data-type="weekly" 
          bindtap="generateReport"
        >ğŸ“Š ç”Ÿæˆå‘¨æŠ¥</button>
      </view>
      
      <!-- æ•°æ®å¯¼å‡º -->
      <view class="export-actions">
        <text class="export-title">æ•°æ®å¯¼å‡º</text>
        <view class="export-buttons">
          <button 
            class="export-btn" 
            data-type="events" 
            bindtap="exportData"
          >ğŸ“‹ å¯¼å‡ºäº‹ä»¶</button>
          <button 
            class="export-btn" 
            data-type="users" 
            bindtap="exportData"
          >ğŸ‘¥ å¯¼å‡ºç”¨æˆ·</button>
          <button 
            class="export-btn" 
            data-type="content" 
            bindtap="exportData"
          >ğŸ“ å¯¼å‡ºå†…å®¹</button>
          <button 
            class="export-btn" 
            data-type="all" 
            bindtap="exportData"
          >ğŸ“¦ å¯¼å‡ºå…¨éƒ¨</button>
        </view>
      </view>
      
      <!-- æŠ¥å‘Šæ˜¾ç¤º -->
      <view class="report-display" wx:if="{{reports.daily || reports.weekly}}">
        <text class="report-title">æœ€æ–°æŠ¥å‘Š</text>
        
        <!-- æ—¥æŠ¥ -->
        <view class="report-content" wx:if="{{reports.daily}}">
          <text class="report-type">ğŸ“… æ—¥æŠ¥ ({{reports.daily.date}})</text>
          <view class="report-summary">
            <text class="summary-item">æ€»äº‹ä»¶: {{reports.daily.summary.total_events}}</text>
            <text class="summary-item">ç‹¬ç«‹ç”¨æˆ·: {{reports.daily.summary.unique_users}}</text>
            <text class="summary-item">ä¼šè¯æ•°: {{reports.daily.summary.unique_sessions}}</text>
          </view>
        </view>
        
        <!-- å‘¨æŠ¥ -->
        <view class="report-content" wx:if="{{reports.weekly}}">
          <text class="report-type">ğŸ“Š å‘¨æŠ¥ ({{reports.weekly.period.start}} - {{reports.weekly.period.end}})</text>
          <view class="report-summary">
            <text class="summary-item">æ€»äº‹ä»¶: {{reports.weekly.summary.total_events}}</text>
            <text class="summary-item">ç‹¬ç«‹ç”¨æˆ·: {{reports.weekly.summary.unique_users}}</text>
            <text class="summary-item">ä¼šè¯æ•°: {{reports.weekly.summary.unique_sessions}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view> 