# 自动清理机制使用指南

## 概述

自动清理机制是一个智能的存储数据管理系统，会在应用启动时自动清理不需要的数据，帮助保持应用性能并释放存储空间。

## 功能特性

### 🧹 自动清理
- **应用启动时自动执行**：每次启动应用时自动清理
- **智能策略**：根据环境（开发/体验/生产）采用不同的清理策略
- **安全清理**：只清理确定不需要的数据，保护重要数据

### 📊 清理统计
- **清理历史记录**：记录每次清理的详细信息
- **统计信息**：显示总清理次数、释放空间等
- **可视化界面**：在管理页面中查看清理状态

### 🔧 手动控制
- **手动清理**：可以手动触发清理操作
- **选择性清理**：支持清理特定类型的数据
- **实时监控**：查看当前存储状态

## 清理策略

### 开发环境 (development)
- **清理支付数据**：✅ 是
- **清理临时数据**：✅ 是
- **清理测试数据**：✅ 是
- **清理废弃数据**：✅ 是
- **最大保留时间**：1天
- **最大存储大小**：5MB

### 体验版环境 (trial)
- **清理支付数据**：❌ 否
- **清理临时数据**：✅ 是
- **清理测试数据**：✅ 是
- **清理废弃数据**：✅ 是
- **最大保留时间**：3天
- **最大存储大小**：8MB

### 生产环境 (production)
- **清理支付数据**：❌ 否
- **清理临时数据**：✅ 是
- **清理测试数据**：❌ 否
- **清理废弃数据**：✅ 是
- **最大保留时间**：7天
- **最大存储大小**：10MB

## 清理的数据类型

### 1. 支付相关数据
- `paymentSettings` - 支付设置
- `paymentOrders` - 支付订单
- `paymentRecords` - 支付记录
- `userWallet` - 用户钱包
- `refunds` - 退款记录

### 2. 临时数据
- `temp_*` - 临时数据
- `cache_*` - 缓存数据
- `tmp_*` - 临时文件

### 3. 测试数据
- `test_*` - 测试数据
- `debug_*` - 调试数据
- `demo_*` - 演示数据

### 4. 过期数据
- 基于时间戳的过期数据
- 超过保留期限的数据

### 5. 大文件数据
- 超过1MB的文件数据
- 图片缓存等大文件

## 使用方法

### 1. 自动清理（推荐）
应用启动时会自动执行清理，无需手动操作。

### 2. 手动清理
在 `pages/simple-test` 页面中：
1. 点击 "🧹 执行自动清理" 按钮
2. 查看清理结果和统计信息

### 3. 控制台命令
```javascript
// 获取应用实例
const app = getApp()

// 执行自动清理
app.performAutoCleanup()

// 手动清理指定键
app.manualCleanup(['paymentSettings'], 'manual')

// 获取清理统计
app.getCleanupStats()

// 获取清理历史
app.getCleanupHistory()
```

## 管理界面

### 存储数据管理页面
访问 `pages/simple-test` 页面可以：

1. **查看当前存储状态**
   - 显示所有存储的键
   - 实时刷新数据

2. **执行清理操作**
   - 自动清理（推荐）
   - 手动清理特定数据
   - 清除所有数据（谨慎使用）

3. **查看统计信息**
   - 总清理次数
   - 总清理键数
   - 总释放空间
   - 平均释放空间

4. **查看清理历史**
   - 最近5次清理记录
   - 清理时间和结果

## 配置说明

### 清理配置
```javascript
// 在 utils/auto-cleanup-manager.js 中配置
cleanupConfig: {
  patterns: {
    payment: ['paymentSettings', 'paymentOrders', ...],
    temp: ['temp_', 'cache_', 'tmp_'],
    test: ['test_', 'debug_', 'demo_'],
    // ... 更多模式
  },
  strategies: {
    development: { /* 开发环境策略 */ },
    production: { /* 生产环境策略 */ },
    trial: { /* 体验版策略 */ }
  }
}
```

### 环境检测
系统会自动检测当前环境：
- `develop` → 开发环境策略
- `trial` → 体验版策略
- `release` → 生产环境策略

## 安全机制

### 数据保护
- **重要数据不清理**：用户信息、应用配置等不会被清理
- **渐进式清理**：不会一次性清理所有数据
- **错误处理**：清理失败不会影响应用运行

### 紧急清理
当存储空间使用超过80%时，会触发紧急清理：
- 删除最旧的20%数据
- 优先保留重要数据
- 记录紧急清理日志

## 监控和调试

### 控制台日志
清理过程会在控制台输出详细日志：
```
🧹 开始自动清理 (环境: development)
🗑️ 清理 payment 数据: paymentSettings (1024 字节)
⏰ 清理过期数据: temp_data (过期时间: 2024-01-01T00:00:00.000Z)
✅ 自动清理完成: 清理了 3 个键，释放了 2048 字节
```

### 错误处理
- 单个键清理失败不会影响整体清理
- 错误信息会记录在清理结果中
- 控制台会显示详细的错误信息

## 最佳实践

### 1. 开发阶段
- 使用开发环境策略，更激进的清理
- 定期检查清理日志
- 测试清理功能是否正常工作

### 2. 测试阶段
- 使用体验版策略，平衡清理和保留
- 验证重要数据不被误删
- 监控存储空间使用情况

### 3. 生产阶段
- 使用生产环境策略，保守的清理
- 定期查看清理统计
- 根据实际使用情况调整策略

### 4. 数据管理
- 为重要数据添加过期时间
- 使用合适的数据大小
- 定期备份重要数据

## 故障排除

### 常见问题

1. **清理不生效**
   - 检查环境配置是否正确
   - 确认数据是否符合清理条件
   - 查看控制台错误信息

2. **重要数据被误删**
   - 检查清理策略配置
   - 确认数据是否被标记为重要
   - 从备份中恢复数据

3. **清理性能问题**
   - 减少清理频率
   - 优化清理策略
   - 分批处理大量数据

### 调试命令
```javascript
// 查看当前存储状态
wx.getStorageInfoSync()

// 查看特定键的数据
wx.getStorageSync('keyName')

// 手动触发清理
getApp().performAutoCleanup()

// 查看清理配置
console.log(autoCleanupManager.cleanupConfig)
```

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本发布
- 支持自动清理功能
- 支持多种清理策略
- 支持清理统计和历史记录

### 计划功能
- 清理策略可视化配置
- 清理计划定时执行
- 清理结果通知推送
- 数据备份和恢复功能
