# 茶叶一点通 API服务器部署指南

## 📋 **部署清单**

### 需要上传的文件：
- ✅ server.py (主API服务器)
- ✅ app.py (备用API服务器)
- ✅ requirements.txt (Python依赖)
- ✅ deploy-simple.sh (部署脚本)
- ✅ server-manager.sh (管理脚本)

### 服务器信息：
- **IP地址**: 82.157.231.110
- **用户名**: root
- **部署路径**: /www/wwwroot/tea-api/

## 🚀 **部署步骤**

### 第一步：上传文件

**请依次执行以下命令（每个命令都需要输入服务器密码）：**

```powershell
# 1. 上传主API服务器
scp server.py root@82.157.231.110:/www/wwwroot/tea-api/

# 2. 上传备用API服务器  
scp app.py root@82.157.231.110:/www/wwwroot/tea-api/

# 3. 上传依赖文件
scp requirements.txt root@82.157.231.110:/www/wwwroot/tea-api/

# 4. 上传部署脚本
scp deploy-simple.sh root@82.157.231.110:/www/wwwroot/tea-api/

# 5. 上传管理脚本
scp server-manager.sh root@82.157.231.110:/www/wwwroot/tea-api/
```

### 第二步：连接服务器

```powershell
ssh root@82.157.231.110
```

### 第三步：执行部署

```bash
# 进入项目目录
cd /www/wwwroot/tea-api

# 设置脚本权限
chmod +x deploy-simple.sh
chmod +x server-manager.sh

# 执行部署
./deploy-simple.sh
```

### 第四步：验证部署

```bash
# 检查服务状态
./server-manager.sh status

# 测试API接口
curl http://localhost:3000/health

# 查看服务日志
./server-manager.sh logs
```

## 🔧 **服务管理命令**

部署完成后，您可以使用以下命令管理API服务：

```bash
# 查看服务状态
./server-manager.sh status

# 启动服务
./server-manager.sh start

# 停止服务
./server-manager.sh stop

# 重启服务
./server-manager.sh restart

# 查看日志
./server-manager.sh logs

# 实时监控
./server-manager.sh monitor

# 测试API接口
./server-manager.sh test
```

## 🌐 **API服务地址**

部署成功后，API服务将在以下地址提供服务：

- **内网地址**: http://localhost:3000
- **外网地址**: http://82.157.231.110:3000

### 主要API接口：

1. **健康检查**: `GET /health`
2. **内容API**: `GET /api/content?type=recommend`
3. **市场API**: `GET /api/market/provinces`
4. **询价API**: `GET /api/inquiry`
5. **品牌API**: `GET /api/brand`
6. **清仓API**: `GET /api/clearance`
7. **新品API**: `GET /api/newarrival`
8. **茶园API**: `GET /api/garden`
9. **供求API**: `GET /api/supply`

## 🔍 **故障排除**

### 常见问题：

1. **上传失败**：
   - 检查网络连接
   - 确认服务器IP和密码正确
   - 确保服务器SSH服务正常

2. **服务启动失败**：
   ```bash
   # 查看详细错误日志
   cat /www/wwwroot/tea-api/api.log
   
   # 检查Python环境
   python3 --version
   
   # 手动安装依赖
   pip3 install flask flask-cors requests
   ```

3. **端口被占用**：
   ```bash
   # 查看端口占用
   netstat -tlnp | grep :3000
   
   # 释放端口
   pkill -f "python.*server.py"
   ```

4. **API无法访问**：
   ```bash
   # 检查防火墙设置
   iptables -L
   
   # 开放3000端口
   iptables -A INPUT -p tcp --dport 3000 -j ACCEPT
   ```

## 📊 **性能监控**

### 实时监控：
```bash
# 启动实时监控
./server-manager.sh monitor
```

### 日志分析：
```bash
# 查看访问日志
tail -f /www/wwwroot/tea-api/api.log

# 查看错误日志
grep -i error /www/wwwroot/tea-api/api.log
```

## 🔄 **更新部署**

当需要更新API服务时：

```bash
# 1. 停止服务
./server-manager.sh stop

# 2. 备份当前版本
cp server.py server.py.backup.$(date +%Y%m%d_%H%M%S)

# 3. 上传新版本（在本地执行）
scp server.py root@82.157.231.110:/www/wwwroot/tea-api/

# 4. 重启服务
./server-manager.sh start

# 5. 测试新版本
./server-manager.sh test
```

## ✅ **部署完成检查清单**

- [ ] 所有文件成功上传
- [ ] Python环境和依赖安装完成
- [ ] API服务启动成功
- [ ] 健康检查通过
- [ ] 端口3000正常监听
- [ ] 主要API接口测试通过
- [ ] 小程序能正常访问API

## 📞 **支持联系**

如遇到部署问题，请提供以下信息：
- 错误日志内容
- 服务器系统版本
- Python版本信息
- 网络连接状态 