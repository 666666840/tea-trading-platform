# 🏗️ 独立管理后台部署指南

## 📋 概述

本指南用于部署完全独立的茶叶平台管理后台系统。管理后台与小程序完全分离，无任何跳转途径，确保最大安全性。

## 🎯 系统架构

### 分离设计
```
┌─────────────────┐    ┌─────────────────┐
│   茶叶小程序     │    │   管理后台系统   │
│                 │    │                 │
│ - 用户端功能     │    │ - 管理员功能    │
│ - 商户端功能     │    │ - 数据管理      │
│ - 内容展示       │    │ - 系统配置      │
│ - 无管理入口     │    │ - 独立访问      │
└─────────────────┘    └─────────────────┘
        │                       │
        │                       │
        └─────── 完全分离 ───────┘
```

### 安全特性
- ✅ **完全分离**：小程序和管理后台无任何连接
- ✅ **独立部署**：管理后台部署在独立服务器
- ✅ **独立域名**：使用独立的域名和SSL证书
- ✅ **独立数据库**：管理后台使用独立数据库
- ✅ **独立认证**：管理后台有自己的用户认证系统

## 🚀 部署步骤

### 第一步：准备服务器

#### 1.1 服务器要求
- **操作系统**：Ubuntu 20.04 LTS 或 CentOS 8
- **CPU**：2核心以上
- **内存**：4GB以上
- **存储**：50GB以上
- **网络**：独立公网IP

#### 1.2 域名准备
- **主域名**：admin.tea-platform.com
- **备用域名**：tea-admin.com
- **SSL证书**：Let's Encrypt 或商业证书

### 第二步：环境配置

#### 2.1 安装基础软件
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y nginx python3 python3-pip nodejs npm git curl wget

# 安装数据库
sudo apt install -y mysql-server redis-server

# 安装防火墙
sudo apt install -y ufw
```

#### 2.2 配置防火墙
```bash
# 开启防火墙
sudo ufw enable

# 允许SSH
sudo ufw allow ssh

# 允许HTTP和HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 允许管理后台端口
sudo ufw allow 8080

# 查看防火墙状态
sudo ufw status
```

### 第三步：部署管理后台

#### 3.1 创建项目目录
```bash
# 创建项目目录
sudo mkdir -p /var/www/tea-admin
sudo chown -R $USER:$USER /var/www/tea-admin
cd /var/www/tea-admin
```

#### 3.2 下载管理后台代码
```bash
# 克隆管理后台代码
git clone https://github.com/your-org/tea-admin.git .

# 或者上传本地代码
# scp -r ./admin-files/* user@server:/var/www/tea-admin/
```

#### 3.3 安装依赖
```bash
# 安装Python依赖
pip3 install -r requirements.txt

# 安装Node.js依赖
npm install

# 构建前端
npm run build
```

#### 3.4 配置数据库
```bash
# 登录MySQL
sudo mysql -u root -p

# 创建数据库和用户
CREATE DATABASE tea_admin CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'tea_admin'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON tea_admin.* TO 'tea_admin'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 3.5 配置环境变量
```bash
# 创建环境配置文件
cat > .env << EOF
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=tea_admin
DB_USER=tea_admin
DB_PASSWORD=your_secure_password

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# 应用配置
APP_SECRET=your_app_secret_key
APP_ENV=production
APP_DEBUG=false

# 管理后台配置
ADMIN_PORT=8080
ADMIN_HOST=0.0.0.0

# 安全配置
JWT_SECRET=your_jwt_secret_key
SESSION_SECRET=your_session_secret

# 邮件配置
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASSWORD=your_email_password

# 文件上传配置
UPLOAD_PATH=/var/www/tea-admin/uploads
MAX_FILE_SIZE=10485760
EOF
```

### 第四步：配置Web服务器

#### 4.1 配置Nginx
```bash
# 创建Nginx配置文件
sudo nano /etc/nginx/sites-available/tea-admin

# 添加以下配置
server {
    listen 80;
    server_name admin.tea-platform.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name admin.tea-platform.com;
    
    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/admin.tea-platform.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.tea-platform.com/privkey.pem;
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 静态文件
    location /static/ {
        alias /var/www/tea-admin/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API接口
    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 管理后台页面
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 4.2 启用站点
```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/tea-admin /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 第五步：配置SSL证书

#### 5.1 安装Certbot
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d admin.tea-platform.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

### 第六步：启动管理后台

#### 6.1 创建系统服务
```bash
# 创建服务文件
sudo nano /etc/systemd/system/tea-admin.service

# 添加以下内容
[Unit]
Description=Tea Admin Backend
After=network.target mysql.service redis.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/var/www/tea-admin
Environment=PATH=/var/www/tea-admin/venv/bin
ExecStart=/var/www/tea-admin/venv/bin/python app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 6.2 启动服务
```bash
# 重新加载服务配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start tea-admin

# 设置开机自启
sudo systemctl enable tea-admin

# 查看服务状态
sudo systemctl status tea-admin
```

### 第七步：安全配置

#### 7.1 配置防火墙规则
```bash
# 只允许特定IP访问管理后台
sudo ufw allow from 192.168.1.0/24 to any port 8080
sudo ufw allow from 10.0.0.0/8 to any port 8080

# 或者使用VPN访问
sudo ufw deny 8080
```

#### 7.2 配置Fail2ban
```bash
# 安装Fail2ban
sudo apt install -y fail2ban

# 配置Fail2ban
sudo nano /etc/fail2ban/jail.local

# 添加以下配置
[nginx-http-auth]
enabled = true
port = http,https
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
bantime = 3600

[nginx-botsearch]
enabled = true
port = http,https
filter = nginx-botsearch
logpath = /var/log/nginx/access.log
maxretry = 2
bantime = 3600
```

#### 7.3 定期备份
```bash
# 创建备份脚本
sudo nano /var/www/tea-admin/backup.sh

# 添加备份内容
#!/bin/bash
BACKUP_DIR="/var/backups/tea-admin"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u tea_admin -p tea_admin > $BACKUP_DIR/db_backup_$DATE.sql

# 备份文件
tar -czf $BACKUP_DIR/files_backup_$DATE.tar.gz /var/www/tea-admin

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

## 🔐 访问管理后台

### 访问地址
- **主地址**：https://admin.tea-platform.com
- **备用地址**：https://tea-admin.com

### 初始管理员账号
- **用户名**：admin
- **密码**：admin123456
- **邮箱**：admin@tea-platform.com

### 首次登录后必须修改
1. 修改默认密码
2. 配置邮箱设置
3. 设置安全策略
4. 创建其他管理员账号

## 📊 监控和维护

### 系统监控
```bash
# 查看服务状态
sudo systemctl status tea-admin nginx mysql redis

# 查看日志
sudo journalctl -u tea-admin -f
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 查看系统资源
htop
df -h
free -h
```

### 定期维护
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 更新管理后台
cd /var/www/tea-admin
git pull origin main
pip3 install -r requirements.txt
sudo systemctl restart tea-admin

# 清理日志
sudo journalctl --vacuum-time=30d
```

## 🚨 安全建议

### 1. 网络安全
- 使用VPN访问管理后台
- 配置IP白名单
- 启用双因素认证
- 定期更新SSL证书

### 2. 系统安全
- 定期更新系统和软件
- 使用强密码策略
- 启用登录失败限制
- 监控异常访问

### 3. 数据安全
- 定期备份数据
- 加密敏感数据
- 限制数据库访问
- 监控数据变更

## 📞 技术支持

### 联系方式
- **技术支持**：admin@tea-platform.com
- **紧急联系**：+86-xxx-xxxx-xxxx
- **文档地址**：https://docs.tea-platform.com

### 常见问题
1. **服务无法启动**：检查端口占用和配置文件
2. **数据库连接失败**：检查数据库服务和连接参数
3. **SSL证书过期**：运行certbot renew更新证书
4. **访问权限被拒绝**：检查防火墙和IP白名单设置

---

**注意**：本指南仅用于部署独立的管理后台系统，与小程序完全分离，确保最大安全性。 